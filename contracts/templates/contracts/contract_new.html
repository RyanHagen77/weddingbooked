<!DOCTYPE html>
<html lang="en">
{% extends "base.html" %}
{% load static %}

{% block head %}
<head>
    <title>New Contract</title>
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <!-- Include Bootstrap Datepicker CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/css/bootstrap-datepicker.min.css">
    <!-- Include your custom CSS file -->
    <link rel="stylesheet" href="{% static 'users/dashboard.css' %}">
    <link rel="stylesheet" href="{% static 'contracts/styles.css' %}">
    <style>
        .form-section {
            display: flex;
            margin: 40px;
            padding: 15px;
            border: 1px solid #ddd;
            background-color: #f9f9f9; /* Light gray background */
        }
        .left-column, .right-column {
            flex: 1;
        }
        .error {
            color: red;
            font-size: 0.875em;
        }
        .is-invalid {
            border-color: #dc3545;
            background-color: #f8d7da;
        }
        .form-text {
            font-size: 0.9em;
            color: #6c757d;
        }
        .btn-dusty-pink {
            background-color: #e57373;
            color: white;
            border-radius: 5px;
            padding: 10px 15px;
            border: none;
            cursor: pointer;
        }
        .btn-dusty-pink:hover {
            background-color: #d32f2f;
        }
    </style>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
</head>
{% endblock head %}

{% block content %}
<body>
    {% if error_message %}
    <div class="alert alert-danger" role="alert">
        {{ error_message }}
    </div>
    {% endif %}

    <div class="modal fade" id="errorModal" tabindex="-1" role="dialog" aria-labelledby="errorModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="errorModalLabel">Form Error</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <ul id="errorList"></ul>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-close" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <form id="contractForm" method="POST" novalidate>
        {% csrf_token %}
        <div class="form-section-container">
            <div class="new-contract-form">
                <div class="left-column">
                    <h5>New Contract</h5>
                    <div>
                        {{ contract_form.is_code_92.label_tag }} {{ contract_form.is_code_92 }}
                        {% if contract_form.is_code_92.errors %}
                            <div class="error">{{ contract_form.is_code_92.errors }}</div>
                        {% endif %}
                    </div>
                    <div>
                        <small class="form-text text-muted">Select the date of the event.</small>
                        {{ contract_form.event_date.label_tag }} {{ contract_form.event_date }}
                        {% if contract_form.event_date.errors %}
                            <div class="error">{{ contract_form.event_date.errors }}</div>
                        {% endif %}
                    </div>
                    <div>
                         <small class="form-text text-muted">Choose the Essence store location from the dropdown.</small>
                        {{ contract_form.location.label_tag }} {{ contract_form.location }}
                        {% if contract_form.location.errors %}
                            <div class="error">{{ contract_form.location.errors }}</div>
                        {% endif %}
                    </div>
                    <div>
                        {{ contract_form.status.label_tag }} {{ contract_form.status }}
                        {% if contract_form.status.errors %}
                            <div class="error">{{ contract_form.status.errors }}</div>
                        {% endif %}
                    </div>
                    <div>
                        {{ contract_form.coordinator.label_tag }} {{ contract_form.coordinator }}
                        {% if contract_form.coordinator.errors %}
                            <div class="error">{{ contract_form.coordinator.errors }}</div>
                        {% endif %}
                    </div>
                    <div>
                        {{ contract_form.csr.label_tag }} {{ contract_form.csr }}
                        {% if contract_form.csr.errors %}
                            <div class="error">{{ contract_form.csr.errors }}</div>
                        {% endif %}
                    </div>
                    <div>
                        {{ contract_form.primary_contact.label_tag }} {{ contract_form.primary_contact }}
                        {% if contract_form.primary_contact.errors %}
                            <div class="error">{{ contract_form.primary_contact.errors }}</div>
                        {% endif %}
                        <small class="form-text text-muted">Enter the full name of the primary contact. Avoid numbers or special characters.</small>
                    </div>
                    <div>
                        {{ contract_form.partner_contact.label_tag }} {{ contract_form.partner_contact }}
                        {% if contract_form.partner_contact.errors %}
                        <div class="error">{{ contract_form.partner_contact.errors }}</div>
                        {% endif %}
                    <small class="form-text text-muted">Enter the full name of the partner contact. Avoid numbers or special characters.</small>
                    </div>
                    <div>
                        {{ contract_form.primary_email.label_tag }} {{ contract_form.primary_email }}
                        {% if contract_form.primary_email.errors %}
                            <div class="error">{{ contract_form.primary_email.errors }}</div>
                        {% endif %}
                        <small class="form-text text-muted">Enter a valid email address (e.g., example@domain.com).</small>
                    </div>
                    <div>
                        {{ contract_form.primary_phone1.label_tag }} {{ contract_form.primary_phone1 }}
                        {% if contract_form.primary_phone1.errors %}
                            <div class="error">{{ contract_form.primary_phone1.errors }}</div>
                        {% endif %}
                        <small class="form-text text-muted">Enter the phone number in the format 123-456-7890.</small>
                    </div>
                    <div>
                        {{ contract_form.bridal_party_qty.label_tag }} {{ contract_form.bridal_party_qty }}
                        {% if contract_form.bridal_party_qty.errors %}
                            <div class="error">{{ contract_form.bridal_party_qty.errors }}</div>
                        {% endif %}
                    </div>
                    <div>
                        {{ contract_form.guests_qty.label_tag }} {{ contract_form.guests_qty }}
                        {% if contract_form.guests_qty.errors %}
                            <div class="error">{{ contract_form.guests_qty.errors }}</div>
                        {% endif %}
                    </div>
                    <div>
                        {{ contract_form.ceremony_site.label_tag }} {{ contract_form.ceremony_site }}
                        {% if contract_form.ceremony_site.errors %}
                            <div class="error">{{ contract_form.ceremony_site.errors }}</div>
                        {% endif %}
                    </div>
                    <div>
                        {{ contract_form.ceremony_city.label_tag }} {{ contract_form.ceremony_city }}
                        {% if contract_form.ceremony_city.errors %}
                            <div class="error">{{ contract_form.ceremony_city.errors }}</div>
                        {% endif %}
                    </div>
                    <div>
                        {{ contract_form.ceremony_state.label_tag }} {{ contract_form.ceremony_state }}
                        {% if contract_form.ceremony_state.errors %}
                            <div class="error">{{ contract_form.ceremony_state.errors }}</div>
                        {% endif %}
                    </div>
                    <div>
                        {{ contract_form.reception_site.label_tag }} {{ contract_form.reception_site }}
                        {% if contract_form.reception_site.errors %}
                            <div class="error">{{ contract_form.reception_site.errors }}</div>
                        {% endif %}
                    </div>
                    <div>
                        {{ contract_form.reception_city.label_tag }} {{ contract_form.reception_city }}
                        {% if contract_form.reception_city.errors %}
                            <div class="error">{{ contract_form.reception_city.errors }}</div>
                        {% endif %}
                    </div>
                    <div>
                        {{ contract_form.reception_state.label_tag }} {{ contract_form.reception_state }}
                        {% if contract_form.reception_state.errors %}
                            <div class="error">{{ contract_form.reception_state.errors }}</div>
                        {% endif %}
                    </div>
                    <div>
                        {{ contract_form.old_contract_number.label_tag }} {{ contract_form.old_contract_number }}
                        {% if contract_form.old_contract_number.errors %}
                            <div class="error">{{ contract_form.old_contract_number.errors }}</div>
                        {% endif %}
                    </div>
                </div>
            <button type="submit" class="btn-dusty-pink">Submit</button>
        </div>
    </div>
    </form>
    <script>
        $(document).ready(function() {
            $('#contractForm').on('submit', function(event) {
                event.preventDefault(); // Prevent default form submission

                let isValid = true;
                let errorList = $('#errorList');
                errorList.empty();

                // Regex patterns
                const namePattern = /^[A-Za-z\s\-']+$/; // Allows letters, spaces, hyphens, apostrophes
                const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/; // Valid email
                const phonePattern = /^\d{3}-\d{3}-\d{4}$/; // 123-456-7890 format

                // Validate each field
                $('#contractForm input, #contractForm select').each(function() {
                    const field = $(this);
                    const label = field.prev('label').text();
                    const value = field.val().trim();
                    const name = field.attr('name');

                    // Check required fields
                    if (field.prop('required') && !value) {
                        isValid = false;
                        errorList.append(`<li>${label} is required.</li>`);
                        field.addClass('is-invalid');
                    }
                    // Specific field validations
                    else if (name === 'primary_contact' && !namePattern.test(value)) {
                        isValid = false;
                        errorList.append(`<li>${label} must only contain letters, spaces, hyphens, or apostrophes.</li>`);
                        field.addClass('is-invalid');
                    } else if (name === 'primary_email' && !emailPattern.test(value)) {
                        isValid = false;
                        errorList.append(`<li>${label} must be a valid email address.</li>`);
                        field.addClass('is-invalid');
                    } else if (name === 'primary_phone1' && !phonePattern.test(value)) {
                        isValid = false;
                        errorList.append(`<li>${label} must be in the format 123-456-7890.</li>`);
                        field.addClass('is-invalid');
                    } else {
                        field.removeClass('is-invalid');
                    }
                });

                if (!isValid) {
                    $('#errorModal').modal('show');
                    return; // Stop further execution if form is invalid
                }

                // Submit the form via AJAX
                let form = $(this);
                let data = form.serialize();
                let url = form.attr('action');

                $.ajax({
                    url: url,
                    type: 'POST',
                    data: data,
                    success: function(response) {
                        if (response.redirect_url) {
                            // Redirect the user to the provided URL
                            window.location.href = response.redirect_url;
                        } else {
                            console.error('No redirect URL provided in the response');
                        }
                    },
                    error: function(response) {
                        let errorList = $('#errorList');
                        errorList.empty();

                        if (response.responseJSON && response.responseJSON.errors) {
                            let errors = response.responseJSON.errors;

                            // Populate error modal with field-specific errors
                            $.each(errors, function(key, value) {
                                errorList.append('<li>' + value.join(', ') + '</li>');
                            });
                            $('#errorModal').modal('show');
                        } else {
                            console.error('Error response not in expected format');
                        }
                    }
                });
            });
        });
    </script>
</body>
{% endblock content %}
</html>
