{% extends "base.html" %}
{% block content %}
<div class="container" style="display: flex;">
    <!-- Days Off List -->
    <div style="flex: 1; padding-right: 20px;">
        <h4>Days Off</h4>
        <table id="daysOffList">
            <tr>
                <th>Date</th>
                <th>Day</th>
                <th>Action</th>
            </tr>
            <!-- Days off will be dynamically listed here -->
        </table>
    </div>

        <!-- Calendar and Bulk Select Controls -->
    <div style="flex: 2;">
        <h4>Schedule for {{ photographer.get_full_name }}</h4>

        <!-- Bulk Select Controls -->
            <div class="bulk-select-controls" style="margin-bottom: 20px;">
                <select id="dayOfWeek">
                    <option value="0">Sunday</option>
                    <option value="1">Monday</option>
                    <option value="2">Tuesday</option>
                    <option value="3">Wednesday</option>
                    <option value="4">Thursday</option>
                    <option value="5">Friday</option>
                    <option value="6">Saturday</option>
                </select>
                <button onclick="selectBulkDaysOff()" style="height: 30px; width: 100px; font-size: 14px; line-height: 15px; padding: 0; margin-top: 10px; font-weight: normal;">Bulk Select</button>
            </div>

            <div id='calendar'></div>
        </div>
    </div>
{% endblock %}

{% block extra_head %}
<link href='https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.10.2/fullcalendar.min.css' rel='stylesheet' />
<script src='https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment.min.js'></script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.10.2/fullcalendar.min.js'></script>
<script>
$(document).ready(function() {
    var calendar = $('#calendar').fullCalendar({
        header: {
            left: 'prev,next today',
            center: 'title',
            right: 'month,agendaWeek,agendaDay'
        },
        defaultView: 'month',
        defaultDate: moment().format('YYYY-MM-DD'),
        navLinks: true,  // can click day/week names to navigate views
        selectable: true,
        selectHelper: true,
        editable: true,
        events: '{% url 'users:get_event_staff_schedule' user_id=photographer.id %}',

        eventAfterAllRender: function(view) {
            updateDaysOffList();
        },

        select: function(start, end) {
            var date = start.format('YYYY-MM-DD');
            if (!$('#calendar').fullCalendar('clientEvents', function(evt) {
                return evt.start.format('YYYY-MM-DD') === date && evt.rendering === 'background';
            }).length) {
                if (confirm("Mark " + date + " as a day off?")) {
                    markDayAsOff(date, false);
                }
            }
            $('#calendar').fullCalendar('unselect');
        },

        eventClick: function(calEvent, jsEvent, view) {
            if (calEvent.rendering === 'background' && confirm("Remove this day off?")) {
                markDayAsOff(calEvent.start.format('YYYY-MM-DD'), true);
            }
        }
    });

    function updateDaysOffList() {
        $('#daysOffList tr:not(:first)').remove(); // Clear existing entries except the header
        var events = $('#calendar').fullCalendar('clientEvents', function(evt) {
            return evt.rendering === 'background';
        });
        events.forEach(function(evt) {
            var date = moment(evt.start);
            $('#daysOffList').append(
                '<tr><td>' + date.format('YYYY-MM-DD') + '</td>' +
                '<td>' + date.format('dddd') + '</td>' +  // Adding day of the week
                '<td><button class="remove-day-off" data-date="' + date.format('YYYY-MM-DD') + '">Clear</button></td></tr>'
            );
        });
    }

        function selectBulkDaysOff() {
        var selectedDay = parseInt($('#dayOfWeek').val(), 10);
        var view = calendar.fullCalendar('getView');
        var startDate = view.start.clone();
        var endDate = view.end.clone();

        while (startDate.isBefore(endDate)) {
            if (startDate.day() === selectedDay) {
                var dateStr = startDate.format('YYYY-MM-DD');
                if (!$('#calendar').fullCalendar('clientEvents', function(evt) {
                    return evt.start.format('YYYY-MM-DD') === dateStr && evt.rendering === 'background';
                }).length) {
                    markDayAsOff(dateStr, false);
                }
            }
            startDate.add(1, 'days');
        }
    }


    function markDayAsOff(date, available) {
        $.ajax({
            url: '{% url "users:update_event_staff_schedule" user_id=photographer.id %}',
            type: 'POST',
            data: {
                date: date,
                available: available,
                csrfmiddlewaretoken: getCSRFToken()
            },
            success: function() {
                calendar.fullCalendar('refetchEvents');
                updateDaysOffList();
            }
        });
    }

    $(document).on('click', '.remove-day-off', function() {
        var date = $(this).data('date');
        if (confirm("Are you sure you want to clear the day off for " + date + "?")) {
            markDayAsOff(date, true);
        }
    });

    function getCSRFToken() {
        return $('input[name="csrfmiddlewaretoken"]').val();
    }
});
</script>
{% endblock %}
