{% extends "office_staff_base.html" %}
{% block content %}
<div class="container" style="display: flex;">
    <div style="flex: 1; display: flex; flex-direction: column; padding: 20px;">
        <!-- Contact Information Section -->
        <div>
            <h4>Contact Information</h4>
            <p><strong>Email:</strong> {{ staff_member.email }}</p>
            <p><strong>Phone:</strong> {{ staff_member.primary_phone1 }}</p>
        </div>
        <!-- Days Off Section -->
        <div>
            <h4>Days Off</h4>
            <table id="daysOffList" class="styled-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Day</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Days off will be dynamically listed here -->
                </tbody>
            </table>
        </div>
        <div class="bulk-select-controls" style="margin-top: 20px;">
            <h6>Select Days Always Off</h6>
            <select id="alwaysOffDay" class="styled-select" multiple>
                <option value="0">Monday</option>
                <option value="1">Tuesday</option>
                <option value="2">Wednesday</option>
                <option value="3">Thursday</option>
                <option value="4">Friday</option>
                <option value="5">Saturday</option>
                <option value="6">Sunday</option>
            </select>
            <button id="updateAvailabilityBtn" class="btn-dusty-pink">Update</button>
        </div>
        <div style="margin-top: 20px;">
            <h4>Always Off</h4>
            <ul id="alwaysOffDays" class="styled-list">
                <!-- Recurring days off will be dynamically listed here -->
            </ul>
        </div>
    </div>
    <!-- Calendar -->
    <div style="flex: 2; padding: 20px;">
        <h4>Schedule for {{ staff_member.get_full_name }}</h4>
        <div id='calendar'></div>
    </div>
</div>
{% endblock %}

{% block extra_head %}
{% load static %}
<link href='https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.10.2/fullcalendar.min.css' rel='stylesheet' />
<script src='https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment.min.js'></script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.10.2/fullcalendar.min.js'></script>

<!-- JavaScript variables embedded in HTML -->
<script>
    var userId = {{ staff_member.id }};
    var staffScheduleUrl = '{% url "users:get_event_staff_schedule" user_id=staff_member.id %}';
</script>

<script src="{% static 'users/js/schedule.js' %}"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    fetch(staffScheduleUrl)
        .then(response => response.json())
        .then(data => {
            // Populate the always off days
            const alwaysOffDaysList = document.getElementById('alwaysOffDays');
            alwaysOffDaysList.innerHTML = '';
            data.alwaysOffDays.forEach(function(day) {
                const li = document.createElement('li');
                li.textContent = day;
                alwaysOffDaysList.appendChild(li);
            });

            // Populate days off, excluding bookings
            const daysOffList = document.getElementById('daysOffList').getElementsByTagName('tbody')[0];
            daysOffList.innerHTML = '';
            data.events.filter(event => event.type === 'day_off').forEach(function(event) {
                const row = daysOffList.insertRow();
                const cellDate = row.insertCell(0);
                const cellDay = row.insertCell(1);
                const cellAction = row.insertCell(2);
                cellDate.textContent = event.start;
                cellDay.textContent = event.day;
                cellAction.innerHTML = `<button class="remove-day-off" data-date="${event.start}">Clear</button>`;
            });

            // Render the calendar
            $('#calendar').fullCalendar({
                events: data.events.filter(event => event.type !== 'day_off'), // Filter out "day_off" for the calendar
                editable: false,
                eventRender: function(event, element) {
                    if (event.type === 'booking') {
                        element.css('background-color', '#378006'); // Bookings in green
                    } else if (event.type === 'always_off') {
                        element.css('background-color', '#ff0000'); // Always off in red
                    }
                }
            });
        })
        .catch(error => console.error('Error fetching schedule data:', error));

    // Attach event listener to update availability button
    document.getElementById('updateAvailabilityBtn').addEventListener('click', function() {
        updateSchedule(userId);
    });

    // Attach event listener to remove day off buttons
    document.addEventListener('click', function(e) {
        if (e.target && e.target.classList.contains('remove-day-off')) {
            const date = e.target.getAttribute('data-date');
            if (confirm(`Are you sure you want to clear the day off for ${date}?`)) {
            fetch(`/users/update_specific_date_availability/${userId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ date: date, available: true }),
            })
                .then(response => {
                    if (!response.ok) throw new Error('Failed to update availability');
                    return response.json();
                })
                .then(() => {
                    alert('Day off removed successfully');
                    location.reload(); // Refresh the page to reflect changes
                })
                .catch(error => alert(`Error: ${error.message}`));

            }
        }
    });
});
</script>
{% endblock %}
