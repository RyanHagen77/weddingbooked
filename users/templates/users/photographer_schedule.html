{% extends "base.html" %}
{% block content %}
<div class="container">
    <h2>Schedule for {{ photographer.get_full_name }}</h2>
    <div id='calendar'></div>

    <div class="bulk-select-controls">
        <label for="dayOfWeek">Choose a day to mark off:</label>
        <select id="dayOfWeek">
            <option value="0">Sunday</option>
            <option value="1">Monday</option>
            <option value="2">Tuesday</option>
            <option value="3">Wednesday</option>
            <option value="4">Thursday</option>
            <option value="5">Friday</option>
            <option value="6">Saturday</option>
        </select>
        <button id="selectDays">Select All</button>
    </div>

    <h3>Days Off</h3>
    <table id="daysOffList">
        <tr>
            <th>Date</th>
            <th>Action</th>
        </tr>
        <!-- Days off will be listed here -->
    </table>
</div>
{% endblock %}

{% block extra_head %}
<link href='https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.10.2/fullcalendar.min.css' rel='stylesheet' />
<script src='https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment.min.js'></script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.10.2/fullcalendar.min.js'></script>
<script>
$(document).ready(function() {
    var calendar = $('#calendar').fullCalendar({
        header: {
            left: 'prev,next today',
            center: 'title',
            right: 'month,agendaWeek,agendaDay'
        },
        defaultView: 'month',
        defaultDate: moment().format('YYYY-MM-DD'),
        navLinks: true,
        selectable: true,
        selectHelper: true,
        editable: true,
        events: '{% url 'users:get_photographer_schedule' user_id=photographer.id %}',

        eventAfterAllRender: function(view) {
            $('#daysOffList tr:not(:first)').remove();  // Clear previous entries except the header
            var events = $('#calendar').fullCalendar('clientEvents', function(evt) {
                return evt.rendering === 'background';
            });

            // Sort events by date if not already sorted
            events.sort(function(a, b) {
                return new Date(a.start) - new Date(b.start);
            });

            events.forEach(function(evt) {
                // Append day name with the date
                $('#daysOffList').append(
                    '<tr><td>' + moment(evt.start).format('YYYY-MM-DD') + ' (' + evt.day + ')' +
                    '</td><td><button class="remove-day-off" data-date="' + evt.start.format('YYYY-MM-DD') + '">Clear</button></td></tr>'
                );
            });
        },

        select: function(start, end) {
            var date = start.format('YYYY-MM-DD');
            if (!$('#calendar').fullCalendar('clientEvents', function(evt) {
                return evt.start.format('YYYY-MM-DD') === date && evt.rendering === 'background';
            }).length) {
                if (confirm("Mark " + date + " as a day off?")) {
                    markDayAsOff(date, false);
                }
            }
            $('#calendar').fullCalendar('unselect');
        },

        eventClick: function(calEvent, jsEvent, view) {
            if (calEvent.rendering === 'background' && confirm("Remove this day off?")) {
                markDayAsOff(calEvent.start.format('YYYY-MM-DD'), true);
            }
        }
    });

    function markDayAsOff(date, available) {
        $.ajax({
            url: '{% url "users:update_photographer_schedule" user_id=photographer.id %}',
            type: 'POST',
            data: {
                date: date,
                available: available,
                csrfmiddlewaretoken: getCSRFToken()
            },
            success: function() {
                calendar.fullCalendar('refetchEvents');
                updateDaysOffList();
            }
        });
    }

    function updateDaysOffList() {
        $('#daysOffList tr:not(:first)').remove(); // Clear existing entries except header
        var events = $('#calendar').fullCalendar('clientEvents', function(evt) {
            return evt.rendering === 'background';
        });
        events.forEach(function(evt) {
            $('#daysOffList').append(
                '<tr><td>' + moment(evt.start).format('YYYY-MM-DD') +
                '</td><td><button class="remove-day-off" data-date="' + evt.start.format('YYYY-MM-DD') + '">Clear</button></td></tr>'
            );
        });
    }

    $(document).on('click', '.remove-day-off', function() {
        var date = $(this).data('date');
        if (confirm("Are you sure you want to clear the day off for " + date + "?")) {
            markDayAsOff(date, true);
        }
    });

    $('#selectDays').click(function() {
        var selectedDay = parseInt($('#dayOfWeek').val(), 10);
        var view = $('#calendar').fullCalendar('getView');
        var startDate = view.start.clone();
        var endDate = view.end.clone();
        while (startDate.isBefore(endDate)) {
            if (startDate.day() === selectedDay) {
                markDayAsOff(startDate.format('YYYY-MM-DD'), false);
            }
            startDate.add(1, 'days');
        }
    });

    function getCSRFToken() {
        return document.cookie.split('; ').find(row => row.startsWith('csrftoken=')).split('=')[1];
    }
});
</script>
{% endblock %}
